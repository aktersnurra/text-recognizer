# @package _global_

defaults:
  - override /network: vqvae
  - override /criterion: null
  - override /model: lit_vqgan
  - override /callbacks: vae
  - override /optimizers: null
  - override /lr_schedulers: null

epochs: &epochs 100
ignore_index: &ignore_index 3
num_classes: &num_classes 58
max_output_len: &max_output_len 682
summary: [[1, 1, 576, 640]]

criterion:
  _target_: text_recognizer.criterion.vqgan_loss.VQGANLoss
  reconstruction_loss:
    _target_: torch.nn.BCEWithLogitsLoss
    reduction: mean
  discriminator:
    _target_: text_recognizer.criterion.n_layer_discriminator.NLayerDiscriminator
    in_channels: 1
    num_channels: 64
    num_layers: 3
  commitment_weight: 0.25
  discriminator_weight: 0.8
  discriminator_factor: 1.0
  discriminator_iter_start: 8.0e4

mapping: &mapping
  mapping:
    _target_: text_recognizer.data.mappings.emnist.EmnistMapping
    extra_symbols: [ "\n" ]

datamodule:
  _target_: text_recognizer.data.iam_extended_paragraphs.IAMExtendedParagraphs
  batch_size: 4
  num_workers: 12
  train_fraction: 0.9
  pin_memory: true
  << : *mapping

lr_schedulers:
  network:
    _target_: torch.optim.lr_scheduler.CosineAnnealingLR
    T_max: *epochs
    eta_min: 1.0e-5
    last_epoch: -1
    interval: epoch
    monitor: val/loss
 
  discriminator:
    _target_: torch.optim.lr_scheduler.CosineAnnealingLR
    T_max: *epochs
    eta_min: 1.0e-5
    last_epoch: -1
    interval: epoch
    monitor: val/loss

optimizers:
  generator:
    _target_: madgrad.MADGRAD
    lr: 1.0e-4
    momentum: 0.5
    weight_decay: 0
    eps: 1.0e-7

    parameters: network

  discriminator:
    _target_: madgrad.MADGRAD
    lr: 4.5e-6
    momentum: 0.5
    weight_decay: 0
    eps: 1.0e-6

    parameters: loss_fn.discriminator

trainer:
  _target_: pytorch_lightning.Trainer
  stochastic_weight_avg: false
  auto_scale_batch_size: binsearch
  auto_lr_find: false
  gradient_clip_val: 0
  fast_dev_run: false
  gpus: 1
  precision: 16
  max_epochs: *epochs
  terminate_on_nan: true
  weights_summary: null
  limit_train_batches: 1.0 
  limit_val_batches: 1.0
  limit_test_batches: 1.0
  resume_from_checkpoint: null
  accumulate_grad_batches: 2
  overfit_batches: 0
